# version: "2.1"

services:
  postgres:
    image: postgres:latest
    environment:
      - POSTGRES_USER=${DATABASE_USER:-postgres}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD:-postgres}
      - POSTGRES_DB=${DATABASE_NAME:-images}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    environment:
      - PORT=${PORT:-8080}
      - DATABASE_URL=postgres://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@postgres:5432/${DATABASE_NAME:-images}?sslmode=disable
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BASE_URL=${BASE_URL:-http://localhost:8080}
      - MAX_FILE_SIZE_TEST=${MAX_FILE_SIZE_TEST:-10485760}
      - MAX_FILE_SIZE_LIVE=${MAX_FILE_SIZE_LIVE:-104857600}
      - CLOUDFRONT_DOMAIN_NAME=${CLOUDFRONT_DOMAIN_NAME}
      - CLOUDFRONT_LOG_BUCKET=${CLOUDFRONT_LOG_BUCKET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PRICE_ID_STARTER=${STRIPE_PRICE_ID_STARTER}
      - STRIPE_PRICE_ID_PRO=${STRIPE_PRICE_ID_PRO}
    volumes:
      # Mount source code for hot-reload
      - .:/app
      # Exclude these directories from the mount to avoid conflicts
      - /app/tmp
      - /app/bin
    depends_on:
      postgres:
        condition: service_healthy

  worker:
    build: .
    command: ./bin/images worker
    environment:
      - DATABASE_URL=postgres://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@postgres:5432/${DATABASE_NAME:-images}?sslmode=disable
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      # Mount source code for hot-reload
      - .:/app
      # Exclude these directories from the mount to avoid conflicts
      - /app/tmp
      - /app/bin
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - worker

volumes:
  pgdata:
